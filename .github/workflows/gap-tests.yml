name: "Run a GAP test suite"

on:
  workflow_dispatch:
    inputs:
      container:
        description: 'GHCR Docker image from gap-system'
        required: true
        type: string
        default: gap-docker-master
      suite:
        required: true
        type: string
        default: testinstall
      pkgs:
        required: true
        type: string
        default: auto

  workflow_call:
    inputs:
      container:
        required: true
        type: string
      suite:
        required: true
        type: string
      pkgs:
        required: true
        type: string

jobs:
  process:
    name: "Process jobs to run"
    runs-on: ubuntu-18.04
    outputs:
      container: ${{ steps.process.outputs.matrix }}
      suite: ${{ steps.process.outputs.suite }}
      pkgs: ${{ steps.process.outputs.pkgs }}
    steps:
      - name: "Assemble job matrix"
        id: process
        run: |
          if [ ${GITHUB_EVENT_NAME} == "workflow_call" ]; then
            CONTAINER=${{ inputs.container }}
            SUITE=${{ inputs.suite }}
            PKGS=${{ inputs.pkgs }}
          else
            CONTAINER="[\"${{ github.event.inputs.container }}\"]"
            SUITE="[\"${{ github.event.inputs.suite }}\"]"
            PKGS="[\"${{ github.event.inputs.pkgs }}\"]"
          fi
          echo "::set-output name=container::$CONTAINER"
          echo "::set-output name=suite::${{ inputs.container || [\"github.event.inputs.container\"]  }}"
          echo "::set-output name=pkgs::$PKGS"

  test:
    needs: process
    name: "${{ matrix.container }} / ${{ matrix.suite }} / ${{ matrix.pkgs }} packages"
    runs-on: ubuntu-18.04
    strategy:
      fail-fast: false
      matrix:
        container: ${{ fromJSON(needs.process.outputs.container) }}
        suite: ${{ fromJSON(needs.process.outputs.suite) }}
        pkgs: ${{ fromJSON(needs.process.outputs.pkgs) }}
    steps:
      - uses: actions/checkout@v2

      - run: docker pull ghcr.io/gap-system/${{ matrix.container }}:master

      - name: "Run GAP's ${{ matrix.suite }} test suite with ${{ matrix.pkgs }} packages"
        run: >
          docker run
          -v $PWD:/home/workspace
          ghcr.io/gap-system/${{ matrix.container }}:master
          /bin/sh -c "TEST_SUITE=${{ matrix.suite }} GAPPKG=${{ matrix.pkgs }} /home/workspace/gap-tests.sh"
